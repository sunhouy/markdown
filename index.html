<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Markdown编辑器</title>
    <link rel="icon" type="image/x-icon" href="icon.png">
    <link rel="stylesheet" href="css/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="vditor@3.11.2/dist/index.css" />
</head>

<body>
<div class="loading" id="loading">正在启动编辑器...</div>

<!-- 同步状态指示器 -->
<div class="sync-status" id="syncStatus">
    <i class="fas fa-sync-alt sync-icon"></i>
    <span id="syncText">正在同步...</span>
</div>

<!-- 文件列表侧边栏 -->
<div class="file-list-sidebar" id="fileListSidebar">
    <div class="file-list-header">
        <h3 class="file-list-title">文件列表</h3>
        <button class="file-list-close" id="fileListClose">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <ul class="file-list" id="fileList">
        <!-- 文件列表将在这里动态生成 -->
    </ul>
    <div class="file-list-actions">
        <button class="add-file-btn" id="addFileBtn">
            <i class="fas fa-plus"></i> 新建文件
        </button>
    </div>
</div>

<!-- 登录注册模态窗口 -->
<div class="modal-overlay" id="loginModalOverlay">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalTitle">登录/注册</h2>
            <p id="modalSubtitle">登录后文档将保存至服务器</p>
        </div>

        <div class="modal-tabs">
            <button class="tab-btn active" id="loginTabBtn">登录</button>
            <button class="tab-btn" id="registerTabBtn">注册</button>
        </div>

        <div class="modal-form" id="loginForm">
            <div class="form-group">
                <label for="loginUsername">用户名</label>
                <input type="text" id="loginUsername" placeholder="请输入用户名">
            </div>
            <div class="form-group">
                <label for="loginPassword">密码</label>
                <input type="password" id="loginPassword" placeholder="请输入密码">
            </div>
            <div class="modal-message" id="loginMessage"></div>
            <div class="modal-actions">
                <button class="modal-btn primary" id="loginSubmitBtn">登录</button>
                <button class="modal-btn secondary" id="loginCancelBtn">取消</button>
            </div>
        </div>

        <div class="modal-form" id="registerForm" style="display: none;">
            <div class="form-group">
                <label for="registerUsername">用户名</label>
                <input type="text" id="registerUsername" placeholder="请输入用户名">
            </div>
            <div class="form-group">
                <label for="registerPassword">密码</label>
                <input type="password" id="registerPassword" placeholder="请输入密码">
            </div>
            <div class="form-group">
                <label for="registerInviteCode">邀请码 (可选)</label>
                <input type="text" id="registerInviteCode" placeholder="请输入邀请码">
            </div>
            <div class="modal-message" id="registerMessage"></div>
            <div class="modal-actions">
                <button class="modal-btn primary" id="registerSubmitBtn">注册</button>
                <button class="modal-btn secondary" id="registerCancelBtn">取消</button>
            </div>
        </div>
    </div>
</div>

<!-- 冲突解决模态窗口 -->
<div class="modal-overlay" id="conflictModalOverlay">
    <div class="modal conflict-modal">
        <div class="modal-header">
            <h2>发现文件冲突</h2>
            <p>以下文件在本地和服务器上存在不同版本</p>
        </div>

        <div class="conflict-info">
            <i class="fas fa-exclamation-triangle"></i>
            请为每个冲突的文件选择保留哪个版本
        </div>

        <div id="conflictList" class="conflict-options">
            <!-- 冲突文件列表将动态生成 -->
        </div>

        <div class="modal-actions">
            <button class="modal-btn primary" id="resolveConflictsBtn">确认解决冲突</button>
            <button class="modal-btn secondary" id="cancelConflictBtn">取消</button>
        </div>
    </div>
</div>

<!-- 历史版本模态窗口 -->
<div class="modal-overlay" id="historyModalOverlay">
    <div class="modal history-modal">
        <div class="modal-header">
            <p id="historyFileName"></p>
        </div>

        <div class="history-info">
            <i class="fas fa-info-circle"></i>
            最多保留1000个历史版本
        </div>

        <div id="historyList" class="history-list">
            <!-- 历史版本列表将动态生成 -->
            <div class="history-loading">
                <i class="fas fa-spinner fa-spin"></i> 正在加载历史版本...
            </div>
        </div>

        <div class="modal-actions">
            <button class="modal-btn secondary" id="closeHistoryBtn">关闭</button>
        </div>
    </div>
</div>

<!-- 编辑器容器 -->
<div class="editor-container">
    <div id="vditor"></div>
</div>

<!-- 顶部工具栏 -->
<div class="mobile-toolbar-container">
    <div class="mobile-toolbar">
        <!-- 文件列表按钮 -->
        <button class="mobile-action-btn" id="mobileFileBtn" title="文件列表">
            <i class="fas fa-folder-open"></i>
        </button>
        <!-- 登录按钮 -->
        <button class="mobile-action-btn" id="mobileLoginBtn" title="登录">
            <i class="fas fa-user"></i>
        </button>
        <h1 class="mobile-title">Markdown编辑器</h1>
        <div class="mobile-dropdown">
            <button class="mobile-action-btn" id="mobileMenuBtn" title="菜单">
                <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="mobile-dropdown-content" id="mobileDropdown">

                <button class="dropdown-item" id="mobileShareBtn"><i class="fas fa-share-alt"></i> 分享</button>
                <button class="dropdown-item" id="mobilePrintBtn"><i class="fas fa-print"></i> 云打印</button>
                <button class="dropdown-item" id="mobileModeBtn"><i class="fas fa-exchange-alt"></i> 切换模式</button>
                <button class="dropdown-item" id="mobileExportBtn"><i class="fas fa-file-export"></i> 导出</button>
                <button class="dropdown-item" id="mobileClearBtn"><i class="fas fa-trash-alt"></i> 清空</button>
                <button class="dropdown-item" id="mobileHelpBtn"><i class="fas fa-question-circle"></i> 帮助</button>
            </div>
        </div>
    </div>
</div>

<!-- 底部操作栏 -->
<div class="mobile-bottom-bar">
    <div class="bottom-bar-buttons">
        <button class="bottom-btn" id="mobileFormatBtn">
            <i class="fas fa-font"></i>
            <span>格式</span>
        </button>
        <button class="bottom-btn" id="mobileInsertBtn">
            <i class="fas fa-plus"></i>
            <span>插入</span>
        </button>
        <button class="bottom-btn" id="mobileFormulaBtn">
            <i class="fas fa-superscript"></i>
            <span>公式</span>
        </button>
        <button class="bottom-btn" id="mobileChartBtn">
            <i class="fas fa-chart-bar"></i>
            <span>图表</span>
        </button>
        <button class="bottom-btn" id="mobileSaveBottomBtn">
            <i class="fas fa-save"></i>
            <span>保存</span>
        </button>
    </div>
</div>

<!-- 夜间模式切换按钮 -->
<button class="editor-mode-toggle" id="modeToggle" title="切换夜间模式">
    <i class="fas fa-moon"></i>
</button>


<!-- 操作面板容器 -->
<div class="mobile-action-sheet" id="mobileActionSheet"></div>
<div class="mobile-action-sheet-overlay" id="mobileActionSheetOverlay"></div>

<!-- 用户菜单下拉 -->
<div class="user-menu-dropdown" id="userMenuDropdown">
    <div class="dropdown-item" id="userInfoItem"></div>
    <button class="dropdown-item" id="logoutItem"><i class="fas fa-sign-out-alt"></i> 退出登录</button>
</div>


<script src="vditor@3.11.2/dist/index.min.js"></script>
<script src="js/html-to-image.min.js"></script>
<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/files.js"></script>
<script src="js/ui.js"></script>
<script src="js/main.js"></script>

<script>
    // 处理分享链接
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const shareId = urlParams.get('share_id');
        const sharePassword = urlParams.get('share_password');
        
        if (shareId) {
            // 等待 Vditor 初始化完成后再处理分享链接
            function waitForVditor() {
                if (window.vditor && window.vditor.setValue && window.vditor.vditor && window.vditor.vditor.ir) {
                    // Vditor 已经完全初始化完成
                    handleShareLink(shareId, sharePassword);
                } else {
                    // Vditor 还没有初始化完成，继续等待
                    setTimeout(waitForVditor, 100);
                }
            }
            waitForVditor();
        }
    });
    
    async function handleShareLink(shareId, password) {
        try {
            // 从API获取分享的文档内容
            const response = await fetch('api/index.php?action=get_share', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    share_id: shareId,
                    password: password
                })
            });
            
            const result = await response.json();
            
            if (result.code === 200) {
                const shareData = result.data;
                
                // 填充编辑器内容
                if (window.vditor) {
                    window.vditor.setValue(shareData.content);
                }
                
                // 根据分享模式调整UI
                if (shareData.mode === 'view') {
                    // 仅查看模式：隐藏工具栏和编辑相关元素
                    hideEditElements();
                } else {
                    // 可编辑模式：保留工具栏
                    // 检查是否过期
                    if (shareData.is_expired) {
                        hideEditElements();
                        showToast('分享链接已过期，无法编辑', 'error');
                    }
                }
                
                // 隐藏登录提示
                if (window.showLoginModal) {
                    // 清除自动显示登录模态框的定时器
                    window.clearTimeout(window.loginModalTimer);
                }
                
                // 显示分享信息
                showShareInfo(shareData);
            } else {
                showToast('获取分享内容失败: ' + (result.message || '未知错误'), 'error');
                // 重定向到密码页面或错误页面
                if (result.code === 401) {
                    window.location.href = 'api/index.php?action=view_share&share_id=' + shareId;
                }
            }
        } catch (error) {
            console.error('处理分享链接失败:', error);
            showToast('网络错误，请重试', 'error');
        }
    }
    
    function hideEditElements() {
        // 隐藏顶部工具栏
        const mobileToolbar = document.querySelector('.mobile-toolbar-container');
        if (mobileToolbar) {
            mobileToolbar.style.display = 'none';
        }
        
        // 隐藏底部操作栏
        const mobileBottomBar = document.querySelector('.mobile-bottom-bar');
        if (mobileBottomBar) {
            mobileBottomBar.style.display = 'none';
        }
        
        // 隐藏文件列表按钮
        const mobileFileBtn = document.getElementById('mobileFileBtn');
        if (mobileFileBtn) {
            mobileFileBtn.style.display = 'none';
        }
        
        // 隐藏登录按钮
        const mobileLoginBtn = document.getElementById('mobileLoginBtn');
        if (mobileLoginBtn) {
            mobileLoginBtn.style.display = 'none';
        }
        
        // 隐藏菜单按钮
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        if (mobileMenuBtn) {
            mobileMenuBtn.style.display = 'none';
        }
        
        // 隐藏夜间模式切换按钮
        const modeToggle = document.getElementById('modeToggle');
        if (modeToggle) {
            modeToggle.style.display = 'none';
        }
        
        // 调整编辑器容器高度
        const editorContainer = document.querySelector('.editor-container');
        if (editorContainer) {
            editorContainer.style.top = '0';
            editorContainer.style.height = '100vh';
        }
    }
    
    function showShareInfo(shareData) {
        // 显示分享信息提示
        let infoMessage = `分享文档: ${shareData.filename}`;
        if (shareData.expires_at) {
            const expiryDate = new Date(shareData.expires_at);
            if (shareData.is_expired) {
                infoMessage += ` (已过期: ${expiryDate.toLocaleString()})`;
            } else {
                infoMessage += ` (有效期至: ${expiryDate.toLocaleString()})`;
            }
        }
        infoMessage += ` (模式: ${shareData.mode === 'view' ? '仅查看' : '可编辑'})`;
        
        showToast(infoMessage, 'info');
    }
    
    function showToast(message, type = 'info') {
        // 创建提示元素
        let toast = document.getElementById('toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toast';
            toast.className = 'toast';
            document.body.appendChild(toast);
        }
        
        // 设置样式
        toast.style.position = 'fixed';
        toast.style.bottom = '24px';
        toast.style.right = '24px';
        toast.style.padding = '12px 24px';
        toast.style.borderRadius = '6px';
        toast.style.background = '#24292e';
        toast.style.color = 'white';
        toast.style.fontSize = '14px';
        toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        toast.style.transform = 'translateY(100px)';
        toast.style.opacity = '0';
        toast.style.transition = 'all 0.3s';
        toast.style.zIndex = '10000';
        
        if (type === 'success') {
            toast.style.background = '#2da44e';
        } else if (type === 'error') {
            toast.style.background = '#cf222e';
        }
        
        // 显示消息
        toast.textContent = message;
        toast.classList.add('show');
        toast.style.transform = 'translateY(0)';
        toast.style.opacity = '1';
        
        // 3秒后隐藏
        setTimeout(() => {
            toast.style.transform = 'translateY(100px)';
            toast.style.opacity = '0';
        }, 3000);
    }
</script>

</body>
</html>